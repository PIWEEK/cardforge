const s=[["Dixit (80 x 120 mm)",302,454],["Tarot (70 x 120)",265,454],["French tarot (61 x 112)",231,423],["Wonder (65 x 100)",246,378],["Volcano (70 x 110)",265,416],["Euro (59 x 92)",223,348],["Asia (57,5 x 89)",217,337],["Standard (63,5 x 88)",240,333],["USA (56 x 87)",212,329],["Square L (80x80)",302,302],["Desert (50 x 75)",189,284],["Square S (70 x 70)",265,265],["Mini EURO (45 x 68)",170,257],["Mini Asia (43 x 65)",163,246],["Mini USA (41 x 63)",155,238]];let o,u;penpot.ui.open("CardForge","",{width:1200,height:650});function m(){let e=penpot.currentPage.getPluginData("cardsData");console.log("loaded cards data:",e);let t=JSON.parse(e);penpot.ui.sendMessage({type:"CARDS_DATA",data:t})}function x(e){var t,n;return((t=e.name)==null?void 0:t.startsWith("#"))&&(e.type=="text"||e.type=="rect"&&((n=e.fills)==null?void 0:n.length)==1&&e.fills[0].fillImage)}function g(e,t){for(let n=0;n<e.children.length;n++){let a=e.children[n];if(x(a)){let i=a.type=="text"?"text":"image";t.push({name:a.name,type:i,id:a.id})}a.hasOwnProperty("children")&&g(a,t)}return t}function P(){const e=penpot.currentPage.getShapeById("00000000-0000-0000-0000-000000000000"),t=f(e,"Front"),n=g(t,[]);penpot.ui.sendMessage({type:"CARD_FIELDS",data:{fields:n,assetsUrl:"https://early.penpot.dev/assets/by-file-media-id/"}})}function f(e,t){var n;for(let a=0;a<e.children.length;a++){let i=e.children[a];if(i.hasOwnProperty("name")&&i.name===t)return i;if(((n=i.children)==null?void 0:n.length)>0){let r=f(i,t);if(r)return r}}}function S(e){penpot.currentPage.name=e.name;const t=penpot.createFrame();t.name="_Images",t.y=-1e3,t.hidden=!0,o=penpot.createFrame(),o.name="Front";const n=penpot.createFrame();n.name="inside",n.borderRadius=5,n.strokes=[{strokeColor:"#000000",strokeStyle:"solid",strokeWidth:5,strokeAlignment:"inner"}];let a=parseInt(e.size),i=s[a][1],r=s[a][2];e.orientation=="landscape"&&(i=s[a][2],r=s[a][1]),o.resize(i,r),n.resize(i-10,r-10),n.x=5,n.y=5,o.appendChild(n),u=o.clone(),u.name="Back",u.x+=o.width+50,penpot.closePlugin()}function D(e){penpot.currentPage.getShapeById("00000000-0000-0000-0000-000000000000").children.length==0?S(e):penpot.ui.sendMessage({type:"ERROR_DECK_CREATE_PAGE_NOT_EMPTY"})}function C(){const e=penpot.currentPage.getShapeById("00000000-0000-0000-0000-000000000000");penpot.ui.sendMessage({type:"PAGE_EMPTY",data:e.children.length==0})}function I(e,t,n,a){penpot.uploadMediaData("image",e,t).then(i=>{var l;const r=penpot.createRectangle();r.resize(i.width,i.height),r.fills=[{fillOpacity:1,fillImage:i}],r.x=0,r.y=0,penpot.currentPage.findShapes({name:"_Images"})[0].appendChild(r),penpot.ui.sendMessage({type:"IMAGE_CREATED",data:{num:n,name:a,id:(l=r.fills[0].fillImage)==null?void 0:l.id,imageId:r.id}})}).catch(i=>console.error(i))}function E(e){let t,n=penpot.currentPage.findShapes({name:"Output"});n.length>0&&n[0].remove(),t=penpot.createFrame(),t.name="Output",t.y=500,t.resize(794,1123);let a=t.addFlexLayout();a.columnGap=30,a.wrap="wrap",a.justifyContent="center",a.alignContent="start";const i=penpot.currentPage.findShapes({name:"Front"})[0];let r;for(let l=0;l<e.length;l++){let p=e[l];r=i.clone(),r.name="card"+String(l+1).padStart(2,"0");for(var d in p)if(p.hasOwnProperty(d)){let c=f(r,d);if(c.type=="text")c.characters=p[d];else{let h=p[d].split("|")[0],y=penpot.currentPage.getShapeById(h);c.fills=y.fills}}t.appendChild(r)}penpot.closePlugin()}penpot.ui.onMessage(e=>{if(console.log("[plugin] message: "),console.log(e),e.type==="create-deck")D(e);else if(e.type==="save-cards-data")penpot.currentPage.setPluginData("cardsData",JSON.stringify(e.data));else if(e.type==="load-cards-data")m();else if(e.type==="load-card-fields")P();else if(e.type==="create-image-data"){const{data:t,mimeType:n,num:a,name:i}=e.data;I(t,n,a,i)}else e.type==="forje-cards"?E(e.data.cardsData):e.type==="is-page-empty"&&C()});
