console.log("Hello from the plugin!");let o,s;penpot.ui.open("CardForge","",{width:1200,height:650});function y(){let e=penpot.currentPage.getPluginData("cardsData");console.log("loaded cards data:",e);let t=JSON.parse(e);penpot.ui.sendMessage({type:"CARDS_DATA",data:t})}function m(e){var t,n;return((t=e.name)==null?void 0:t.startsWith("#"))&&(e.type=="text"||e.type=="rect"&&((n=e.fills)==null?void 0:n.length)==1&&e.fills[0].fillImage)}function u(e,t){for(let n=0;n<e.children.length;n++){let a=e.children[n];if(m(a)){let i=a.type=="text"?"text":"image";t.push({name:a.name,type:i,id:a.id})}a.hasOwnProperty("children")&&u(a,t)}return t}function P(){const e=penpot.currentPage.getShapeById("00000000-0000-0000-0000-000000000000"),t=f(e,"Front"),n=u(t,[]);penpot.ui.sendMessage({type:"CARD_FIELDS",data:{fields:n,assetsUrl:"https://early.penpot.dev/assets/by-file-media-id/"}})}function f(e,t){var n;for(let a=0;a<e.children.length;a++){let i=e.children[a];if(i.hasOwnProperty("name")&&i.name===t)return i;if(((n=i.children)==null?void 0:n.length)>0){let r=f(i,t);if(r)return r}}}function C(e){penpot.currentPage.name=e.name;const t=penpot.createFrame();t.name="_Images",t.y=-1e3,t.hidden=!0,o=penpot.createFrame(),o.name="Front";const n=penpot.createFrame();n.name="inside",n.borderRadius=10,n.strokes=[{strokeColor:"#000000",strokeStyle:"solid",strokeWidth:10,strokeAlignment:"inner"}],console.log(e),e.size=="P1"&&(e.orientation=="portrait"?(o.resize(238,333),n.resize(218,313)):(o.resize(333,238),n.resize(313,218)),n.x=10,n.y=10),o.appendChild(n),s=o.clone(),s.name="Back",s.x+=o.width+50}function D(e){penpot.currentPage.getShapeById("00000000-0000-0000-0000-000000000000").children.length==0?C(e):penpot.ui.sendMessage({type:"ERROR_DECK_CREATE_PAGE_NOT_EMPTY"})}function F(e,t,n,a){penpot.uploadMediaData("image",e,t).then(i=>{var l;const r=penpot.createRectangle();r.resize(i.width,i.height),r.fills=[{fillOpacity:1,fillImage:i}],r.x=0,r.y=0,penpot.currentPage.findShapes({name:"_Images"})[0].appendChild(r),penpot.ui.sendMessage({type:"IMAGE_CREATED",data:{num:n,name:a,id:(l=r.fills[0].fillImage)==null?void 0:l.id,imageId:r.id}})}).catch(i=>console.error(i))}function I(e){let t,n=penpot.currentPage.findShapes({name:"Output"});n.length>0&&n[0].remove(),t=penpot.createFrame(),t.name="Output",t.y=500,t.resize(794,1123);let a=t.addFlexLayout();a.columnGap=30,a.wrap="wrap",a.justifyContent="center",a.alignContent="start",console.log(a);const i=penpot.currentPage.findShapes({name:"Front"})[0];let r;for(let l=0;l<e.length;l++){let p=e[l];r=i.clone(),r.name="card"+String(l+1).padStart(2,"0");for(var d in p)if(p.hasOwnProperty(d)){let c=f(r,d);if(c.type=="text")c.characters=p[d];else{let g=p[d].split("|")[0],h=penpot.currentPage.getShapeById(g);c.fills=h.fills}}t.appendChild(r)}penpot.closePlugin()}penpot.ui.onMessage(e=>{if(console.log("message: ",e),e.type!=="duplicate")if(e.type==="create-deck")D(e);else if(e.type==="save-cards-data")penpot.currentPage.setPluginData("cardsData",JSON.stringify(e.data));else if(e.type==="load-cards-data")y();else if(e.type==="load-card-fields")P();else if(e.type==="create-image-data"){const{data:t,mimeType:n,num:a,name:i}=e.data;F(t,n,a,i)}else e.type==="forje-cards"&&I(e.data.cardsData)});
